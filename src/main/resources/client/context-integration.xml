<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-ip="http://www.springframework.org/schema/integration/ip"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-4.3.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration/ip http://www.springframework.org/schema/integration/ip/spring-integration-ip-4.3.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-4.3.xsd">
		
	<!-- Tcp Client -->

	<int:gateway 
		service-interface="com.example.springintegration.client.gateway.ClientTcpGateway" 
		default-request-channel="outboudChannel"
		default-reply-channel="inboundChannel"
		error-channel="errorChannel"
		async-executor="gatewayExecutor" >
	</int:gateway>
	
	<bean id="sslContextSupport"
	    class="org.springframework.integration.ip.tcp.connection.DefaultTcpSSLContextSupport">
	    <constructor-arg value="${keystore.path}"/>
	    <constructor-arg value="${truststore.path}"/>
	    <constructor-arg value="${keystore.password}"/>
	    <constructor-arg value="${truststore.password}"/>
	</bean>
		
	<int-ip:tcp-connection-factory 
		id="connFactory"
	    type="client"
	    host="${server.host}"
	    port="${server.port}"
	    using-nio="true"
	    serializer="codec"
		deserializer="codec"
		ssl-context-support="sslContextSupport" />
   	
   	<int:channel id="outboudChannel" />
   	
   	<int:chain input-channel="outboudChannel" output-channel="outputChannel">
		<int:transformer expression="payload.writeData()" />
	</int:chain>
	
	<int:channel id="outputChannel" />
	
   	<int-ip:tcp-outbound-gateway 
   		id="outboundGateway"
   		connection-factory="connFactory"
   		request-channel="outputChannel"
   		reply-channel="inputChannel" >
   		
   		<int-ip:request-handler-advice-chain>
   			<ref bean="retryAdvice"/>
   		</int-ip:request-handler-advice-chain>
   		
   	</int-ip:tcp-outbound-gateway>
   		
   	<int:channel id="inputChannel" />
	
	<int:chain input-channel="inputChannel" output-channel="inboundChannel">
		<int:transformer expression="@isoMessageFactory.parseMessage(payload, 0)" />
	</int:chain>
	
	<int:channel id="inboundChannel" />
	
  	<!-- Error -->
  	
   	<int:transformer 
		input-channel="errorChannel"
        method="handleError">
    	<bean class="com.example.springintegration.client.error.ErrorHandler" />    
    </int:transformer>
  
  	<!-- Bean -->
  	
  	<bean id="codec" class="org.springframework.integration.ip.tcp.serializer.ByteArrayLengthHeaderSerializer" />
  	
  	<bean id="retryAdvice" class="org.springframework.integration.handler.advice.RequestHandlerRetryAdvice">
		<property name="retryTemplate" ref="retryTemplate" />
	</bean>
   			
  	<bean id="retryTemplate" class="org.springframework.retry.support.RetryTemplate">
		<property name="retryPolicy">
			<bean class="org.springframework.retry.policy.SimpleRetryPolicy">
				<property name="maxAttempts" value="4" />
			</bean>
		</property>
		<property name="backOffPolicy">
			<bean class="org.springframework.retry.backoff.ExponentialBackOffPolicy">
				<property name="initialInterval" value="1000" />
				<property name="multiplier" value="5" />
			</bean>
		</property>
	</bean>
	
	<bean id="gatewayExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolExecutorFactoryBean">
		<property name="corePoolSize" value="3" />
		<property name="maxPoolSize" value="5" />
		<property name="keepAliveSeconds" value="60" />
		<property name="allowCoreThreadTimeOut" value="true" />
		<property name="queueCapacity" value="10" />
		<property name="threadNamePrefix" value="gateway-" />
		<property name="rejectedExecutionHandler" ref="abortPolicy"/>
	</bean>
	
	<bean id="abortPolicy" class="java.util.concurrent.ThreadPoolExecutor.AbortPolicy" />
</beans>
